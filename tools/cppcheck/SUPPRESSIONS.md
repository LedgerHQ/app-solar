# MISRA C:2012 Deviations

The following is the list of MISRA C:2012 deviations for the codebase. Each deviation includes its justification, scope, and implementation notes. These deviations have been reviewed and approved for their specific use cases within the project.

## Deviations related to MISRA C:2012 Rules:

| Rule identifier      | Justification                                                                                                                                                               | Notes                                                                                                                                                                                                                                                                                                                                 |
|----------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Rule 2.5 (Advisory)  | False positive in device platform guard statements for UI text constants.                                                                                                   | Affects UI component files:</br>- src/ui/operations/transaction/types/ui_burn.h:19</br>- src/ui/operations/transaction/types/ui_ipfs.h:19</br>- src/ui/operations/transaction/types/ui_transfer.h:19</br>- src/ui/operations/transaction/types/ui_vote.h:19,20                                                                        |
| Rule 3.1 (Required)  | The Apache License notice is from Ledger SAS and should not be modified.                                                                                                    | Affects multiple source files at line 1:</br>- src/address.c</br>- src/app_main.c</br>- src/apdu/dispatcher.c</br>- src/crypto/crypto.c</br>- src/handler/get_*.c files</br>- src/helper/send_response.c</br>- src/ui/ui_utils.c                                                                                                      |
| Rule 8.4 (Required)  | SDK-prescribed UX_FLOW and UX_STEP BAGL macros define objects with external linkage without explicit header declarations. These are managed entirely within the Ledger SDK. | Affects UI display files:</br>- src/ui/menu/display_menu_nano.c:35-69</br>- src/ui/operations/address/display_address_nano.c:40-54</br>- src/ui/operations/message/display_message_nano.c:34-54</br>- src/ui/operations/public_key/display_pubkey_nano.c:42-56</br>- src/ui/operations/transaction/display_transaction_nano.c:280-310 |
| Rule 8.7 (Required)  | `app_main` is defined externally in the Ledger SDK; declaration matches SDK definition.                                                                                     | Affects:</br>- src/app_main.c:47                                                                                                                                                                                                                                                                                                      |
| Rule 8.7 (Advisory)  | Generated by Ledger SDK. Functions and objects with external linkage are intentional and cannot be modified.                                                                | Affects generated files in build directories:</br>- build/*/gen_src/glyphs.c for nanos2, nanox, flex, stax                                                                                                                                                                                                                            |
| Rule 8.7 (Advisory)  | SDK-prescribed UX_FLOW and UX_STEP BAGL macros define externally linked objects that are referenced in a single translation unit.                                           | Affects UI files:</br>- src/ui/action/quit.c:15</br>- Multiple display files with documented line numbers                                                                                                                                                                                                                             |
| Rule 8.9 (Required)  | File-scoped variables flagged by this rule are safely encapsulated within their respective modules. Some instances are required by the Ledger SDK (UX macros).              | Project-wide deviation with controlled scope and safety measures                                                                                                                                                                                                                                                                      |
| Rule 8.11 (Advisory) | Generated by Ledger SDK. Arrays with external linkage lack explicit size declarations.                                                                                      | Affects:</br>- build/*/gen_src/glyphs.h for all platforms                                                                                                                                                                                                                                                                             |
| Rule 10.1 (Required) | Bitwise operations between CX_ECSCHNORR_BIP0340 and CX_RND_TRNG flags are intentional and type-safe.                                                                        | Affects:</br>- src/crypto/crypto.c:179</br>Used for cryptographic API parameters                                                                                                                                                                                                                                                      |
| Rule 12.1 (Advisory) | The operator precedence of the 'AVAILABLE_WIDTH' macro is SDK-defined.                                                                                                      | Affects:</br>- src/ui/operations/transaction/review.c:125                                                                                                                                                                                                                                                                             |
| Rule 12.2 (Required) | The bitwise OR operation between SDK-defined constants cannot exceed parameter width.                                                                                       | Affects:</br>- src/crypto/crypto.c:179                                                                                                                                                                                                                                                                                                |
| Rule 15.5 (Advisory) | Multiple return points allow for efficient error handling and code clarity.                                                                                                 | Project-wide deviation for error handling patterns                                                                                                                                                                                                                                                                                    |
| Rule 16.3 (Required) | Intentional fallthrough as SIGN_MESSAGE is handled identically to SIGN_TX.                                                                                                  | Affects:</br>- src/apdu/dispatcher.c:119                                                                                                                                                                                                                                                                                              |
| Rule 18.8 (Required) | Array size is fixed with compile-time constants, not VLA.                                                                                                                   | Affects:</br>- src/helper/send_response.c:93                                                                                                                                                                                                                                                                                          |
| Rule 19.2 (Required) | Direct union member access based on instruction/transaction type.                                                                                                           | Affects transaction handling:</br>- src/app_types.h:49</br>- src/transaction/types.h:24,26,33</br>- src/transaction/deserialise_transaction.h:17</br>- src/transaction/deserialise_transaction.c:151</br>- src/transaction/types/types.h:8                                                                                            |
| Rule 20.1 (Required) | SDK-generated files may not follow standard include placement.                                                                                                              | Affects all glyph files in build directories                                                                                                                                                                                                                                                                                          |
| Rule 20.7 (Required) | String templates following Ledger review intent guidelines.                                                                                                                 | Affects:</br>- src/ui/operations/transaction/helpers/intent.h:5,10                                                                                                                                                                                                                                                                    |
| Rule 21.6 (Required) | Controlled use of `snprintf` with proper buffer management.                                                                                                                 | Affects UI and transaction handling:</br>- src/ui/operations/transaction/helpers/memo.c:11</br>- src/ui/operations/transaction/types/ui_transfer.c:12</br>- src/ui/operations/transaction/types/ui_vote.c:12</br>- src/ui/ui_utils.c:32                                                                                               |

## Unmatched Suppressions

| Suppression               | Justification                                                                                            |
|---------------------------|----------------------------------------------------------------------------------------------------------|
| -Glyph noise suppression- | -Suppress glyphs.h warnings from non-targeted devices:</br>- build/*/gen_src/glyphs.c for all platforms- |
| Unused Function           | - `app_main`: External Ledger SDK definition</br>- `quit_app`: Called by SDK UX macros                   |

## Additional Considerations:

1. **SDK Dependencies**: Many deviations result from necessary interactions with the Ledger SDK, particularly in UI and cryptographic operations.
2. **Safety Measures**: All deviations are supported by:
   - Explicit justification
   - Scope limitation
   - Safety controls where applicable
   - SDK compliance requirements
3. **Documentation**: Each deviation is traceable to specific files and line numbers for audit purposes.

For any new code additions, contributors should:
1. Reference these documented deviations
2. Follow the established patterns
3. Document any new deviations following this format
